<!DOCTYPE html>
<html lang="en" xmlns:sec="http://www.w3.org/1999/xhtml" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <title>Title</title>
</head>
<body>
    <!--프로필 수정-->
    <div id="profileUpdate">
        <section>
            <div>
                <!-- login form-->
                <div>
                    <div>
                        <div>
                            <h2>회원정보 수정</h2>
                            <form id="updateForm" onsubmit="return false">
                                <div class="form-floating mb-3">
                                    <input class="form-control" id="password" name="password" type="password" onkeyup="passwordValidCkFnc()" maxlength="20" required placeholder="비밀번호 입력">
                                    <span id="passwordCkMsg"></span>
                                    <label for="password">패스워드</label>
                                </div>
                                <div class="form-floating mb-3">
                                    <input class="form-control" id="passwordCk" name="passwordCk" type="password"  onkeyup="passwordMatchCkFnc()" maxlength="20" required placeholder="비밀번호 확인">
                                    <span id="passwordMatchMsg"></span>
                                    <label for="passwordCk">패스워드 확인</label>
                                </div>
                                <div class="form-floating mb-3">
                                    <input class="form-control" id="email" name="email" type="text" th:value="${member.email}" maxlength="30" disabled>
                                    <label for="email">이메일</label>
                                </div>



                                <div class="d-grid"><button class="btn btn-primary btn-lg" id="submitBtn" type="button">회원정보 수정</button></div>
                            </form>
                        </div>
                        <div class="d-grid"><button class="btn btn-primary btn-lg" id="deleteBtn" type="button">회원 탈퇴</button></div>
                    </div>

                </div>
            </div>
        </section>
    </div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        crossorigin="anonymous"></script>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script> <!-- jQuery -->
<script th:inline="javascript">
    window.onload = function () {
        const alertMsg = [[${msg}]];
        if (alertMsg) {
            alert(alertMsg);
        }
    }

    const userName = [[${member.userName}]];
    //패스워드 정규식 체크용 flag변수
    let passwordCk = false;
    //패스워드 중복확인용 flag변수
    let passwordMatchCk = false;


    //비밀번호 정규식
    function passwordValidCkFnc() {
        //영어 숫자 조합 8자리 이상~25자 이하
        const regExp = /^(?=.*[A-Za-z])(?=.*\d)[A-Za-z\d]{8,20}$/;
        let password = $('#password').val();
        let passwordCkMsg = $('#passwordCkMsg');
        if (!regExp.test(password)){
            passwordCkMsg.text("영어 숫자 조합 8~20자 이내로 해주세요!");
            passwordCkMsg.css('color', "red");
            passwordCk = false;
        } else {
            passwordCkMsg.text("사용가능합니다!!");
            passwordCkMsg.css('color', "blue");
            passwordCk = true;
        }
    }

    //패스워드 일치여부 확인
    function passwordMatchCkFnc() {
        //비밀번호 체크
        let password = document.querySelector("#password").value;
        let passwordCk = document.querySelector("#passwordCk").value;
        let passwordMatchMsg = $('#passwordMatchMsg');
        if (password !== passwordCk || password === '' || passwordCk === ''){
            passwordMatchMsg.text("패스워드가 일치하지 않습니다!");
            passwordMatchMsg.css('color', "red");
            passwordMatchCk = false;
        } else {
            passwordMatchMsg.text("패스워드가 일치합니다!");
            passwordMatchMsg.css('color', "blue");
            passwordMatchCk = true;
        }
    }

    //회원탈퇴 버튼 클릭 시 동작
    $('#deleteBtn').click(function (event){
        let deleteCkMsg = confirm("정말로 탈퇴 하시겠습니까?");
        //한번 더 물어보는 alert 추가
        if (!deleteCkMsg){
            alert("탈퇴가 취소되었습니다.");
        } else {
            $.ajax({
                type   : "POST",
                url    : "/findNationalFlag/deleteProfile",
                data   : {
                    userName : userName
                },
                success : function (result){
                    alert("탈퇴 되었습니다!");
                    window.location.href = "/findNationalFlag";
                },
                error:function (error){
                    alert("에러가 발생했습니다." + error);
                }
            })
        }

    });

    //수정 버튼 클릭 시 동작
    $('#submitBtn').click(function (event){
        //기본 폼 제출 방지
        event.preventDefault();

        const passwordVal = $('#password').val();
        const passwordCkVal = $('#passwordCk').val();
        const emailVal = $('#email').val();

        if (
            passwordVal.trim()===''||
            passwordCkVal.trim()===''||
            emailVal.trim()===''
        ){
            alert("비어있는 값이 있는지 확인해주세요!");
        } else if (passwordCk !== true){
            alert("올바른 비밀번호인지 확인해주세요!")
        }
        //비밀번호 일치 체크 여부 확인
        else if (passwordMatchCk !== true){
            alert("비밀번호 일치 체크를 진행해주세요!")
        } else {
            const formData = {
                userName : userName,
                password: passwordVal
            };

            $.ajax({
                type : "POST",
                url : "/findNationalFlag/updateProfile",
                contentType: "application/json",
                data: JSON.stringify(formData),
                success : function (result){
                    alert("수정되었습니다!");
                    window.location.href = "/findNationalFlag/profile";
                },
                error:function (error){
                    alert("에러가 발생했습니다." + error);
                }
            });
        }
    });
</script>
</body>
</html>