<!DOCTYPE html>
<html lang="en" xmlns:sec="http://www.w3.org/1999/xhtml" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <title>홈</title>
    <style>
        .countryFlag{
            width: 300px;
            height: 180px;
        }
    </style>
</head>
<body>
<div class="container centered-container">
    <!-- 로그인 및 회원가입 버튼 (익명 사용자만 보임) -->
    <div sec:authorize="isAnonymous()" class="centered-container-new">
        <p>
        <h6><strong>회원가입</strong> 및 <strong>로그인</strong>을 하면 메뉴를 이용하실 수 있습니다.</h6>
        </p>
        <p>
            <a href="/findNationalFlag/loginForm" class="btn btn-warning btn-spacing">로그인</a>
            <a href="/findNationalFlag/joinForm" class="btn btn-warning btn-spacing">회원가입</a>
        </p>
    </div>

    <!-- 마이프로필 및 로그아웃 버튼 (인증된 사용자만 보임) -->
    <div sec:authorize="isAuthenticated()" class="centered-container-new">
        <p>
        <h6>반갑습니다, <strong><span th:text="${member.getUserName()}"></span></strong>님!</h6>
        </p>
        <p>
        <form action="/findNationalFlag/logout" method="post" style="display: inline;">
            <a href="/findNationalFlag/profile" class="btn btn-info btn-spacing" style="margin-right: 10px;">마이페이지</a>
            <input type="submit" value="로그아웃" class="btn btn-danger">
        </form>
        </p>
    </div>
</div>
<hr>
<div>
    <!-- 나라이름 입력 창 -->
    <input type="text" id="countryName" name="countryName" placeholder="나라이름 입력">
    <!-- 나라이름 확인 버튼 -->
    <button type="button" id="searchFlagBtn">국기 검색</button>
</div>
<div id="flagResult">
<!--    <p id="countryNameResult"></p>-->
<!--    <img alt="국기" class="countryFlag" src="/img/flag/defaultSearchImg.PNG">-->
</div>
<!--국기 추가. 관리자 권한만 가능-->
<div th:if="${#strings.equals(member.getAuthority().getAuthority(), '관리자')}">
    관리자만 보입니다.
    <form id="insertFlag" onsubmit="return false" enctype="multipart/form-data">
        <div class="form-floating mb-3">
            <input class="form-control" id="flagImg" name="flagImg" type="file" required placeholder="국기 이미지 업로드">
            <label for="flagImg">국기 이미지</label>
        </div>
        <div class="form-floating mb-3">
            <input class="form-control" id="newCountryName" name="newCountryName" type="text" required placeholder="국가명">
            <label for="newCountryName">국가명</label>
        </div>
        <button class="btn btn-primary btn-lg" id="insertFlagBtn" type="button">국기 추가</button>
    </form>
</div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        crossorigin="anonymous"></script>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script> <!-- jQuery -->
<script th:inline="javascript">
    window.onload = function () {
        const alertMsg = [[${msg}]];
        const authType = [[${member.getAuthority().getAuthority()}]];
        if (alertMsg) {
            alert(alertMsg);
        }
        if (authType === '비활성사용자'){
            alert("마이페이지에서 메일 인증을 진행해주세요!");
            window.location.href = "/findNationalFlag/profile";
        }
    }
    //국기 검색
    document.querySelector("#searchFlagBtn").addEventListener("click", function (){
        let countryName = document.querySelector("#countryName").value;
        countryName = countryName.replace(/\s+/g, '');
        if (countryName === ""){
            alert("나라이름을 확인해주세요.");
            return;
        }
        $.ajax({
            type : "GET",
            url  : "findNationalFlag/country/searchFlag",
            data : { countryName : countryName },
            success : function (result){
                //부모 element에, 자식 element 값이 있으면 삭제
                //이전검색기록 삭제 후 다시 나타내기
                let flagResult = document.querySelector("#flagResult");
                let flagResultAppend = $('#flagResult');
                if (flagResult.hasChildNodes()){
                    flagResult.replaceChildren();
                }
                $.each(result, function (index, country){
                    flagResultAppend.append("<p class='countryNameResult'>"+country.countryName+"</p>");
                    flagResultAppend.append("<img class='countryFlag' src="+country.flagPath+">");
                });

                //countryNameResult.text(result.countryName);
                //countryFlag.attr({src : result.flagPath});
            },
            error : function (error){
                alert("국가를 찾을 수 없습니다.");
            }
        });
    });

    //국기 추가
    $('#insertFlagBtn').click(function (event) {
        //기본 폼 제출 방지
        event.preventDefault();
        //국기 이미지와 국가명
        let flagImg = $('#flagImg')[0].files[0];
        let newCountryNameVal = $('#newCountryName').val();

        if (flagImg === undefined){
            alert("국기 이미지를 업로드해주세요!");
        } else if (newCountryNameVal.trim()===''){
            alert("국가명을 확인해주세요!");
        } else {
            //back으로 보낼 data.
            //국가명과 국기이미지를 같이 보낸다.
            const countryData = {
                newCountryName : newCountryNameVal
            };
            let formData = new FormData();
            formData.append("countryData", new Blob([JSON.stringify(countryData)], {type:"application/json"}))
            formData.append("flagImg", flagImg);

            $.ajax({
                type : "POST",
                url : "/findNationalFlag/country/insertFlag",
                contentType: false,
                processData : false,
                data: formData,
                success : function (result){
                    if (result === 1){
                        alert("등록이 불가합니다. 국가명 / 국가이미지명을 확인해주세요.");
                    } else if(result === 0){
                        alert("추가되었습니다!");
                        window.location.href = "/findNationalFlag";
                    }
                },
                error:function (error){
                    alert("에러가 발생했습니다." + error);
                }
            });
        }
    });

</script>
</body>
</html>